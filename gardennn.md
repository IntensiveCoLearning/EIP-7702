---
timezone: UTC+8
---

> è¯·åœ¨ä¸Šè¾¹çš„ timezone æ·»åŠ ä½ çš„å½“åœ°æ—¶åŒº(UTC)ï¼Œè¿™ä¼šæœ‰åŠ©äºä½ çš„æ‰“å¡çŠ¶æ€çš„è‡ªåŠ¨åŒ–æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰æ·»åŠ ï¼Œé»˜è®¤ä¸ºåŒ—äº¬æ—¶é—´ UTC+8 æ—¶åŒº


# Garden

1. Hi æˆ‘æ˜¯ Garden
2. ç›¡åŠ›å®Œæˆ
3. TG: @gardenxu

## Notes

<!-- Content_START -->

### 2025.05.14

### EIP-7702ï¼šæ¦‚å¿µå…¥é–€èˆ‡èƒŒæ™¯è„ˆçµ¡

#### ç‚ºä»€éº¼éœ€è¦å¸³æˆ¶æŠ½è±¡ï¼ŸAccount Abstraction çš„å‹•æ©Ÿ

ä»¥å¤ªåŠåŸç”Ÿå¸³æˆ¶åˆ†ç‚ºï¼š
- EOAï¼ˆExternally Owned Accountï¼‰ï¼šå‚³çµ±éŒ¢åŒ…ï¼Œåªæœ‰ç§é‘°ï¼Œä¸èƒ½å…§å»ºé‚è¼¯ã€‚
- åˆç´„å¸³æˆ¶ï¼ˆContract Accountï¼‰ï¼šæœ‰ç¨‹å¼é‚è¼¯ï¼Œå¯è‡ªè¨‚åŸ·è¡Œè¦å‰‡ï¼Œä½†éƒ¨ç½²å¾Œä¸æ˜“ä¿®æ”¹ã€‚

å¸³æˆ¶æŠ½è±¡ï¼ˆAccount Abstractionï¼‰å¸Œæœ›æ‰“ç ´é€™å€‹äºŒåˆ†æ³•ï¼š
- è®“ EOA ä¹Ÿèƒ½æ”¯æ´è‡ªè¨‚é‚è¼¯ï¼ˆå¦‚å¤šç°½ã€é™é¡ã€ç¤¾äº¤æ¢å¾©ï¼‰ã€‚
- æ”¯æ´æ‰¹æ¬¡äº¤æ˜“ã€è‡ªè¨‚é©—ç°½é‚è¼¯ã€ç”± DApp ä»£ä»˜ Gas ç­‰åŠŸèƒ½ã€‚

#### EIP-4337 å›é¡§èˆ‡é™åˆ¶

EIP-4337ï¼ˆAccount Abstraction via EntryPoint contractï¼‰ç‚ºç¬¬ä¸€ä»£å¸³æˆ¶æŠ½è±¡æ–¹æ¡ˆï¼Œå…¶è¨­è¨ˆåŒ…å«ï¼š
- **Bundler**ï¼šæ”¶é›†ä½¿ç”¨è€…æ“ä½œï¼ˆUserOperationï¼‰ä¸¦çµ±ä¸€é€å‡ºã€‚
- **EntryPoint** åˆç´„ï¼šçµ±ä¸€è™•ç†é©—è­‰èˆ‡åŸ·è¡Œã€‚
- æ”¯æ´ `paymaster`ï¼ˆç”±ä»–äººä»£ä»˜ gasï¼‰ã€‚

ä½†ä¹Ÿå­˜åœ¨é™åˆ¶ï¼š
- éœ€è¦ç¨ç«‹ mempoolï¼Œä¸è¢«æ‰€æœ‰å®¢æˆ¶ç«¯æ”¯æ´ã€‚
- åŸ·è¡Œæµç¨‹è¤‡é›œã€å­¸ç¿’æ›²ç·šé«˜ã€‚
- ä¸å±¬æ–¼ L1 å”è­°å±¤åŠŸèƒ½ï¼ŒåŸ·è¡Œæ•ˆç‡èˆ‡æ•´åˆæœ‰é™ã€‚

#### EIP-7702ï¼šæ ¸å¿ƒæ¦‚å¿µèˆ‡å‰µæ–°

EIP-7702 æ˜¯ Vitalik ä¸»å°çš„æ–°ææ¡ˆï¼Œæ ¸å¿ƒç‚ºï¼š
- ç‚º EOA æä¾› **å‹•æ…‹é‚è¼¯å§”æ´¾** çš„èƒ½åŠ›ã€‚
- EOA çš„ `code` æ¬„ä½å¯æš«æ™‚è¨­å®šç‚º `0xef0100 || address`ï¼Œå³æŒ‡å‘æŸå€‹é‚è¼¯åˆç´„ï¼ˆDelegation contractï¼‰ã€‚
- åœ¨äº¤æ˜“çµæŸå¾Œï¼Œè‡ªå‹•æ¸…é™¤ `code` æ¬„ä½ï¼Œå›åˆ°åŸå§‹ç‹€æ…‹ã€‚

ç‰¹è‰²å¦‚ä¸‹ï¼š
- ç„¡éœ€ Bundlerï¼Œç›´æ¥æ”¯æ´åœ¨ L1 ä¸Šçš„å¸³æˆ¶æŠ½è±¡ã€‚
- ç„¡éœ€åœ¨å¸³æˆ¶åœ°å€é‡æ–°éƒ¨ç½²åˆç´„ï¼Œå³å¯ç‚º EOA é™„åŠ åŸ·è¡Œé‚è¼¯ã€‚
- é©åˆæ‰¹æ¬¡æ“ä½œã€gas è´ŠåŠ©ã€å‹•æ…‹ç°½åé©—è­‰ã€‚

#### Type 4 æ–°äº¤æ˜“æ ¼å¼èˆ‡æ¯”è¼ƒ

| é¡å‹ | åç¨±       | ç‰¹é»                         | å°æ‡‰ EIP    |
|------|------------|------------------------------|-------------|
| 0    | Legacy     | æœ€æ—©æœŸçš„äº¤æ˜“æ ¼å¼             | ç„¡          |
| 1    | EIP-2930   | æ”¯æ´ `access list`           | Berlin      |
| 2    | EIP-1559   | å‹•æ…‹ gas æ¨¡å‹ï¼ˆBase Feeï¼‰    | London      |
| 4    | EIP-7702   | å‹•æ…‹é™„åŠ  delegation è¡Œç‚º     | Pectra      |

Type 4 æ˜¯ 7702 å¼•å…¥çš„å°ˆå±¬æ ¼å¼ï¼Œå…è¨±ä¸€æ¬¡æ€§é™„åŠ  delegation code pointer èˆ‡ authorization listã€‚

#### delegation pointer çš„æ ¼å¼èˆ‡æ„ç¾©

EIP-7702 ä½¿ç”¨çš„ delegation pointerï¼š
```
0xef0100 || address
```
- `0xef0100` æ˜¯ prefixï¼Œä»£è¡¨é€™æ˜¯ä¸€ç­† delegationã€‚
- `address` æ˜¯è¢«å§”è¨—çš„é‚è¼¯åˆç´„ä½å€ã€‚
- æ•´é«”æ§‹æˆå¸³æˆ¶ `code` æ¬„ä½çš„å…§å®¹ï¼Œè®“ EVM åŸ·è¡Œæ™‚åˆ¤æ–·è¦ç”¨ delegatecall å‘¼å«æ­¤åœ°å€ã€‚
- æ­¤æ©Ÿåˆ¶ä½¿å¾— EOA èƒ½åƒ proxy ä¸€æ¨£åŸ·è¡Œå¤–éƒ¨é‚è¼¯ï¼Œä¸¦ä¿ç•™è‡ªèº«çš„ storage contextã€msg.senderã€msg.value

### 2025.05.15

### EIP-7702ï¼šSet Code Transaction

#### Set Code Transaction æ¦‚è¿°

EIP-7702 å¼•å…¥äº† Type 4 äº¤æ˜“ï¼Œä¸€ç¨®æ–°çš„äº¤æ˜“æ ¼å¼ï¼Œå…è¨± EOAï¼ˆExternally Owned Accountï¼‰å°‡å¸³æˆ¶è¡Œç‚ºå§”æ´¾çµ¦æŒ‡å®šçš„é‚è¼¯åˆç´„ã€‚é€™æ˜¯é€é `authorization_list` æ¬„ä½å¯¦ç¾ï¼šè©²æ¬„ä½ä¸­è¨˜éŒ„çš„ç°½åæˆæ¬Šè³‡è¨Šæœƒè®“å¸³æˆ¶çš„ `code` æ¬„ä½è¢«è¨­å®šç‚º `0xef0100 || address`ï¼Œå½¢æˆ delegation æŒ‡ç¤ºå™¨ï¼Œä½¿è©²å¸³æˆ¶å…·å‚™å¦‚åŒ proxy çš„è¡Œç‚ºèƒ½åŠ›ã€‚

#### Type 4 äº¤æ˜“æ ¼å¼

Type 4 æ˜¯åŸºæ–¼ EIP-2718 çš„æ“´å……æ ¼å¼ï¼Œå…¶äº¤æ˜“çµæ§‹å¦‚ä¸‹ï¼š

```js
rlp([
  chain_id,
  nonce,
  max_priority_fee_per_gas,
  max_fee_per_gas,
  gas_limit,
  destination,
  value,
  data,
  access_list,
  authorization_list,
  signature_y_parity,
  signature_r,
  signature_s
])
```

å…¶ä¸­ `authorization_list` æ˜¯ç”±å¸³æˆ¶ç°½åçš„ä¸€çµ„æˆæ¬Šè³‡æ–™ï¼Œç”¨ä¾†æŒ‡å®šå§”æ´¾é‚è¼¯ï¼š

```js
authorization_list = [
  [chain_id, address, nonce, y_parity, r, s],
  ...
]
```

#### æˆæ¬Šé©—è­‰èˆ‡ Delegation è¨­å®šæµç¨‹

ç•¶äº¤æ˜“åŸ·è¡Œå‰ï¼ŒEthereum æœƒä¾åºè™•ç† `authorization_list` ä¸­çš„æ¯ä¸€ç­†æˆæ¬Šï¼š

1. é©—è­‰ `chain_id` æ˜¯å¦ç‚º 0 æˆ–ç­‰æ–¼ç•¶å‰éˆ IDã€‚
2. é©—è­‰ `nonce` æ˜¯å¦å°æ–¼ 2^64ã€‚
3. ä½¿ç”¨ `ecrecover` é©—è­‰ç°½ç« ä¸¦å–å¾—æˆæ¬Šå¸³æˆ¶ `authority`ã€‚
4. é©—è­‰è©²å¸³æˆ¶çš„ `code` æ¬„ä½ç‚ºç©ºæˆ–å·²æœ‰ delegationã€‚
5. è‹¥æ¢ä»¶ç¬¦åˆï¼Œè¨­å®šå¸³æˆ¶ `code = 0xef0100 || address`ã€‚
6. è‹¥ `address == 0`ï¼Œå‰‡ä»£è¡¨æ¸…é™¤ delegationï¼Œå›å¾©ç‚ºä¸€èˆ¬ EOAã€‚
7. å°‡ `authority` çš„ nonce å¢åŠ  1ï¼Œé˜²æ­¢é‡æ”¾æ”»æ“Šã€‚

æ³¨æ„ï¼šå³ä¾¿äº¤æ˜“é‚è¼¯ `revert`ï¼Œä¸Šè¿° code è¨­å®šä»æœƒç”Ÿæ•ˆä¸æœƒè¢«é‚„åŸã€‚

#### Delegation æŒ‡ç¤ºå™¨çš„ EVM è¡Œç‚º

ç•¶å¸³æˆ¶çš„ `code` æ¬„ä½ç‚º `0xef0100 || address`ï¼ˆ23 bytesï¼‰ï¼ŒEVM åœ¨åŸ·è¡Œè©²å¸³æˆ¶æ™‚æœƒå¥—ç”¨ä»¥ä¸‹é‚è¼¯ï¼š

- CALL / CALLCODE / DELEGATECALL / STATICCALL é€™äº›æŒ‡ä»¤ï¼Œæœƒè·³è½‰è‡³ delegation contract çš„é‚è¼¯åŸ·è¡Œã€‚
- åŸ·è¡Œé‚è¼¯æ™‚ï¼Œä»ä¿æœ‰åŸ EOA çš„ `msg.sender`ã€`msg.value`ã€storage contextã€‚
- CODESIZE / CODECOPY ç­‰æœƒå¾ delegation contract è®€å–å¯¦éš›é‚è¼¯ã€‚
- EXTCODESIZE / EXTCODECOPY / EXTCODEHASH å‰‡ä»è®€å–åŸå¸³æˆ¶è‡ªèº«è³‡è¨Šï¼ˆåƒ…çœ‹åˆ° delegation indicator çš„ 23 bytesï¼‰ã€‚

æ­¤æ©Ÿåˆ¶è®“ EOA æ“æœ‰åƒ proxy åˆç´„çš„èƒ½åŠ›ï¼Œä½†ç„¡éœ€éƒ¨ç½² smart contract å³å¯äº«æœ‰æŠ½è±¡å¸³æˆ¶é‚è¼¯ã€‚

### 2025.05.16

### EIP-7702ï¼šäº¤æ˜“æµç¨‹è§£æï¼ˆè‡ªæˆ‘ç™¼èµ·èˆ‡è´ŠåŠ©è€…ï¼‰

EIP-7702 çš„æ ¸å¿ƒåœ¨æ–¼è®“ EOA åœ¨ä¸éƒ¨ç½²åˆç´„çš„å‰æä¸‹ï¼Œè—‰ç”±è¨­å®šç‰¹æ®Š code delegationï¼ˆ`0xef0100 || address`ï¼‰ï¼Œå…·å‚™å‹•æ…‹åŸ·è¡Œé‚è¼¯çš„èƒ½åŠ›ã€‚ä¸»è¦åˆ†ç‚ºå…©ç¨®äº¤æ˜“æµç¨‹ï¼š

---

#### ä¸€ã€è‡ªæˆ‘ç™¼èµ·ï¼ˆSelf-sponsoredï¼‰

ç•¶ EOA è‡ªèº«æ“æœ‰ ETH ä¸”èƒ½æ”¯ä»˜ gas æ™‚ï¼Œå¯ä¸»å‹•ç™¼é€ Type 4 äº¤æ˜“å®Œæˆ delegation èˆ‡åŸ·è¡Œé‚è¼¯ï¼š

1. **EOA è‡ªè¡Œç°½ç½²æˆæ¬Šä¸¦ç™¼é€ Type 4 äº¤æ˜“**
   - ä½¿ç”¨è€…ï¼ˆsenderï¼‰å³ signerï¼Œç°½ç½²ä¸€ç­† [chain_id, address, nonce] çš„æˆæ¬Šè³‡æ–™ã€‚
   - authorization æ ¼å¼ï¼š`[chain_id, address, nonce, y_parity, r, s]`ã€‚
   - ç°½ç« çš„ msg ç‚º `keccak256(0x05 || rlp(chain_id, address, nonce))`ï¼Œecrecover é‚„åŸå‡º authorityï¼ˆå³è©² EOAï¼‰ï¼Œå…¶ code æ¬„ä½æœƒè¢«è¨­ç‚º delegation pointerã€‚

2. **EVM è™•ç†æˆæ¬Šèˆ‡ delegation è¨­å®š**
   - é©—è­‰ç°½ç« æ­£ç¢ºã€nonce åˆç†ã€å¸³æˆ¶ code å¿…é ˆç‚ºç©ºæˆ–å¯è¦†è“‹ delegationã€‚
   - é©—è­‰é€šéå¾Œï¼Œå°‡è©²å¸³æˆ¶ code è¨­ç‚º `0xef0100 || address`ï¼Œå³æŒ‡å‘ delegation contractã€‚

3. **åŸ·è¡Œäº¤æ˜“ dataï¼ˆcallï¼‰**
   - è‹¥äº¤æ˜“ç›®çš„åœ°å€å³ç‚º authorityï¼Œå‰‡æœƒè§¸ç™¼ä»£ç†é‚è¼¯ï¼ˆåŸ·è¡Œ delegation contract çš„é‚è¼¯ï¼Œä¿ç•™åŸ msg.senderã€msg.valueã€storageï¼‰ã€‚
   - è‹¥ call revertï¼Œå‰‡äº¤æ˜“åŸ·è¡Œçµæœæœƒå›æ»¾ï¼Œä½† code è¨­å®šä¸æœƒé‚„åŸã€‚

---

#### äºŒã€è´ŠåŠ©è€…æ¨¡å¼ï¼ˆSponsoredï¼‰

ç•¶ EOA æ²’æœ‰ ETH æˆ–å¸Œæœ›ä»–äººä»£ä»˜ gasï¼Œå¯æ¡ç”¨è´ŠåŠ©è€…æ¨¡å¼ï¼š

1. **ä½¿ç”¨è€…ç°½ç½²é›¢ç·šæˆæ¬Šè³‡è¨Š**
   - è¢«æˆæ¬Šçš„ EOA ç°½ç½² [chain_id, address, nonce]ï¼Œç”¢ç”Ÿç°½ç« ï¼ˆsigner åƒ…ç”¨æ–¼è¨­å®šè©² EOA çš„ codeï¼‰ã€‚
   - ç°½ç« çš„ msg ç‚º `keccak256(0x05 || rlp(chain_id, address, nonce))`ï¼Œecrecover é‚„åŸå‡º authorityï¼ˆå³è¢«æˆæ¬Šå¸³æˆ¶ï¼‰ï¼Œå…¶ code æ¬„ä½æœƒè¢«è¨­ç‚º delegation pointerã€‚
   - æˆæ¬Šä¸­çš„ nonce å¿…é ˆåŒ¹é…è©² EOA ç•¶å‰ nonceï¼Œç¢ºä¿æ¯ç­† delegation åªèƒ½è¨­å®šä¸€æ¬¡ï¼Œç„¡æ³•é‡æ”¾ã€‚

2. **Sponsor çµ„åˆä¸¦æäº¤ Type 4 äº¤æ˜“**
   - Sponsor åƒ…è² è²¬å°‡æˆæ¬Šæ¸…å–®ï¼ˆauthorization_listï¼‰èˆ‡ call data çµ„æˆäº¤æ˜“ä¸¦é€å‡ºï¼Œä¸åƒèˆ‡ç°½ç« ã€‚
   - å¯åŒæ™‚åŒ…å«å¤šç­†æˆæ¬Šï¼ˆå¤šå€‹ EOAï¼‰ï¼Œä»¥åŠå–®ä¸€æˆ–æ‰¹æ¬¡ call dataã€‚
   - ç°½ååƒ…ç”¨æ–¼è¨­å®šæˆæ¬Šè€…å¸³æˆ¶çš„ codeï¼Œè€Œä¸æ˜¯ signer çš„å¸³æˆ¶ã€‚

3. **EVM è™•ç†æˆæ¬Šèˆ‡ delegation è¨­å®š**
   - å°æ¯ç­†æˆæ¬Šè³‡æ–™ï¼Œé©—è­‰ç°½ç« ã€nonce æ˜¯å¦æ­£ç¢ºï¼Œä¸¦æª¢æŸ¥è©²å¸³æˆ¶ code å¿…é ˆç‚ºç©ºæˆ– delegation indicatorã€‚
   - è‹¥æˆæ¬Šè³‡æ–™ç„¡æ•ˆï¼ˆç°½ç« éŒ¯èª¤ã€nonce ä¸ç¬¦ã€code éç©ºï¼‰ï¼Œå‰‡è©²ç­†æˆæ¬Šè¢«æ‹’çµ•ï¼Œç•¥éä¸è™•ç†ã€‚
   - é©—è­‰é€šéè€…ï¼Œå°‡å…¶ code è¨­ç‚º delegation pointerï¼Œä¸¦å°‡ nonce å¢åŠ  1ã€‚

4. **åŸ·è¡Œäº¤æ˜“ä¸»é«” call**
   - æ¯ç­† call data æœƒä»¥å°æ‡‰çš„ delegated EOA ç‚ºä¸Šä¸‹æ–‡åŸ·è¡Œï¼ˆé€é delegation contractï¼‰ã€‚
   - è‹¥å¤šå€‹æˆæ¬Šå¸³æˆ¶å…±ç”¨ç›¸åŒ call dataï¼Œdelegation contract éœ€æ ¹æ“š `msg.sender` å€åˆ†åŸ·è¡Œé‚è¼¯ï¼Œå¦å‰‡å¯èƒ½å°è‡´æ··æ·†æˆ–è³‡å®‰å•é¡Œã€‚

5. **revert èˆ‡æ‰¹æ¬¡è™•ç†è¡Œç‚º**
   - è‹¥äº¤æ˜“éç¨‹ä¸­ä»»ä¸€ç­† call ç™¼ç”Ÿ revertï¼Œæ•´é«”äº¤æ˜“æœƒå›æ»¾ï¼ˆatomicity preservedï¼‰ã€‚
   - è‹¥åƒ… delegation æˆæ¬Šå¤±æ•—ï¼ˆå¦‚ç°½ç« éŒ¯èª¤ã€nonce ä¸ç¬¦ã€code éç©ºï¼‰ï¼Œå‰‡ä¸å½±éŸ¿å…¶ä»–æˆæ¬Šèˆ‡ä¸»é«” call çš„åŸ·è¡Œã€‚

---

#### é©—è­‰èˆ‡å®‰å…¨æ€§è£œå……

- **ç°½ç« ä¸å¯é‡è¤‡ä½¿ç”¨**ï¼šæ¯ç­† delegation æˆæ¬Šå¿…é ˆç¶å®šå”¯ä¸€ nonceï¼Œåªæœ‰ nonce èˆ‡å¸³æˆ¶ç•¶å‰ nonce ç›¸ç¬¦æ™‚æ‰èƒ½è¨­å®š delegationã€‚é€™ç¢ºä¿ replay protectionã€‚
- **å¤šç­†äº¤æ˜“å«ç›¸åŒç°½ç« æœƒè¢«æ‹’çµ•**ï¼šè‹¥å¤šç­†äº¤æ˜“å˜—è©¦é‡ç”¨ç›¸åŒç°½ç« ï¼Œå›  nonce ä¸ç¬¦æˆ– code éç©ºï¼Œæˆæ¬Šæ­¥é©Ÿæœƒè¢«æ‹’çµ•ã€‚
- **ç°½ç« é©—è­‰æ–¹å¼**ï¼š`ecrecover(keccak256(0x05 || rlp(chain_id, address, nonce)), y_parity, r, s)` å–å¾— authorityï¼ˆå³è¢«æˆæ¬Šå¸³æˆ¶ï¼‰ã€‚

---

æ­¤å…©ç¨®æ¨¡å¼çš†å…è¨± EOA åœ¨ç„¡éœ€é å…ˆéƒ¨ç½²æ™ºèƒ½åˆç´„çš„å‰æä¸‹ï¼Œå¯¦ç¾ä¸€æ¬¡æ€§æˆ–å‹•æ…‹å§”æ´¾è‡ªè¨‚é‚è¼¯ï¼Œä¸¦é…åˆ L1 äº¤æ˜“æ©Ÿåˆ¶åŸ·è¡Œï¼Œç‚ºå¸³æˆ¶æŠ½è±¡æä¾›æ›´åŸç”Ÿä¸”å½ˆæ€§çš„æ¶æ§‹ã€‚

### 2025.05.17

### EIP-7702ï¼šå®‰å…¨æ€§è€ƒé‡

#### å¸¸è¦‹é¢¨éšªèˆ‡é˜²ç¯„å»ºè­°

- **é¿å…ä½¿ç”¨ `tx.origin` ä½œç‚ºé‡å…¥ä¿è­·ï¼ˆReentrancy Guardï¼‰**ï¼š
  EIP-7702 æ”¹è®Šäº† `msg.sender == tx.origin` çš„åˆ¤æ–·æ–¹å¼ï¼Œå»ºè­°ä½¿ç”¨ transient å„²å­˜æˆ–æ¨™æº–é–æ©Ÿåˆ¶å–ä»£ `tx.origin`ã€‚

- **é¿å…ä½¿ç”¨åŸå­åˆå§‹åŒ–ï¼ˆatomic initï¼‰**ï¼š
  åŸå­åŒ– `init()` å‘¼å«å¯èƒ½é­åˆ°å‰ç½®æ”»æ“Šï¼ˆfrontrunningï¼‰ï¼Œå»ºè­°ä½¿ç”¨ `initWithSig` æ­é…ç°½ç« é©—è­‰åˆå§‹åŒ–é‚è¼¯ã€‚

- **åˆå§‹åŒ–æ‡‰é€é EntryPoint å‘¼å«ä»¥æå‡å®‰å…¨æ€§**ï¼š
  è‹¥æ¡ç”¨ 4337-compatible çš„æ¶æ§‹ï¼Œåˆå§‹åŒ–é‚è¼¯æ‡‰é™åˆ¶ç”± EntryPoint å‘¼å«ä»¥é¿å…æœªæˆæ¬Šé…ç½®ã€‚

- **é¿å… storage layout è¡çªï¼ˆStorage Collisionsï¼‰**ï¼š
  åˆ‡æ› delegation contract æ™‚æ‡‰ç¢ºä¿ä½¿ç”¨ ERC-7201 å‘½åç©ºé–“ç­‰æ©Ÿåˆ¶ï¼Œé¿å…ä¸åŒåˆç´„ä¹‹é–“ç™¼ç”Ÿå­˜å„²æ¬„ä½è¦†è“‹ã€‚

- **é¿å…å§”æ´¾è‡³å…·å‹•æ…‹è¡Œç‚ºçš„åˆç´„ï¼ˆå¦‚ upgradeable æˆ– selfdestructï¼‰**ï¼š
  åƒ…æ‡‰å§”æ´¾è‡³é€é `CREATE2` éƒ¨ç½²ã€ä¸å¯è®Šçš„é‚è¼¯åˆç´„ï¼Œé˜²æ­¢é‡£é­šèˆ‡æ„å¤–é‚è¼¯æ”¹è®Šã€‚

- **æœ€å°åŒ–ä¿¡ä»»åŸºç¤èˆ‡æ”»æ“Šé¢ï¼ˆTrusted Surfaceï¼‰**ï¼š
  Delegation contract æ‡‰ä¿æŒé‚è¼¯ç°¡å–®ã€åŠŸèƒ½å°é–‰ã€å¯å¯©è¨ˆï¼Œé¿å…å‹•æ…‹ dispatch æˆ–ä¸å¿…è¦çš„å¤–éƒ¨å‘¼å«ã€‚

- **é¸ç”¨å·²å¯©è¨ˆèˆ‡å¯ä¿¡ä»»çš„æ¨™æº–åˆç´„æ¨¡çµ„**ï¼š
  å„ªå…ˆæ¡ç”¨ä¾†è‡ª Ambireã€Alchemyã€MetaMask æˆ– EF ç­‰å·²çŸ¥åœ˜éšŠç¶­è­·ä¸¦å¯©è¨ˆéçš„æ¨¡çµ„åŒ–åˆç´„è¨­è¨ˆã€‚

### 2025.05.18

### EIP-7702ï¼šDelegation åˆç´„çš„è¨­è¨ˆåŸå‰‡

#### ä¸€ã€è¨­è¨ˆæ ¸å¿ƒèˆ‡éƒ¨ç½²åŸå‰‡

- å§”æ´¾åˆç´„æ‡‰é€é **CREATE2 éƒ¨ç½²**ï¼Œä¿è­‰ deterministic addressï¼Œå¯é å…ˆé©—è­‰èˆ‡éœæ…‹æŒ‡å‘ã€‚
- åˆç´„é‚è¼¯æ‡‰æ˜ç¢ºä¸å¯è®Šï¼Œ**é¿å…ä½¿ç”¨ upgradeable patterns æˆ–å…·æ¯€ææ€§çš„ selfdestruct**ã€‚
- æ¯å€‹ delegation contract æ‡‰å°æ‡‰ç‰¹å®šæ¥­å‹™ç›®çš„ï¼Œé¿å…è¬ç”¨ dispatch çµæ§‹ã€‚

#### äºŒã€ç°½ç« é©—è­‰èˆ‡ä½¿ç”¨è€…æˆæ¬Šç¶å®š

- æ¯ç­†ç°½ç« æ‡‰èˆ‡äº¤æ˜“ä¸­å¯¦éš›ä½¿ç”¨çš„ **msg.senderã€calldataã€gasã€valueã€nonceï¼ˆæˆ– saltï¼‰ä¸€è‡´**ã€‚
- EIP-7702 çš„ç°½ç« é©—è­‰æ ¼å¼ç‚ºï¼š`ecrecover(keccak256(0x05 || rlp([chain_id, address, nonce])), y_parity, r, s)`
- ç‚ºæå‡äº’é€šæ€§èˆ‡å®‰å…¨æ€§ï¼Œæ¨è–¦ä½¿ç”¨ **EIP-712 æ¨™æº–æ ¼å¼** å»ºç«‹ç°½ç« å…§å®¹ã€‚

#### ä¸‰ã€å¤šä½¿ç”¨è€…æ”¯æ´è¨­è¨ˆ

- è‹¥å…è¨±å¤šå¸³æˆ¶å…±ç”¨ delegation contractï¼Œæ‡‰è¨­è¨ˆé©ç•¶è³‡æ–™çµæ§‹ä»¥ç®¡ç†æ¬Šé™ï¼Œä¾‹å¦‚ï¼š
  ```solidity
  mapping(address => Permission) public permissions;
  ```
- å¯æ“´å……è¨­è¨ˆå¦‚ï¼š
  - æ¯å€‹ signer å¯è¢«é™åˆ¶åƒ…èƒ½å‘¼å«ç‰¹å®šå‡½å¼ selector
  - æ”¯æ´æ¯æ—¥é™é¡ã€å¯äº’å‹•çš„ target contract ç™½åå–®ç­‰

#### å››ã€meta è³‡è¨Šèˆ‡é¢¨æ§æ“´å……æ¬„ä½

- å»ºè­°åŠ å…¥ç°½ç« åƒæ•¸ï¼š
  - `purpose`ï¼šæ˜ç¢ºè¡¨ç¤ºç°½ç« ç”¨é€”ï¼ˆå¦‚ mintã€transferï¼‰
  - `chainId`ï¼šé˜²æ­¢è·¨éˆé‡æ”¾æ”»æ“Š
  - `deadline`ï¼šç°½ç« éæœŸæ™‚é–“
- å¯è€ƒæ…®åŠ ä¸Š session IDã€é˜²é‡æ”¾ hashã€æˆ–äº¤æ˜“ domain ä½œç‚ºé¡å¤–é©—è­‰ã€‚

#### äº”ã€å®‰å…¨èˆ‡å¯©è¨ˆå»ºè­°

- æ¯ç­†ç°½ç« åªèƒ½ç”¨ä¸€æ¬¡ï¼Œnonce æ‡‰èˆ‡å¸³æˆ¶ç•¶å‰ nonce ç²¾æº–åŒ¹é…ï¼Œé¿å…é‡è¤‡æˆæ¬Šã€‚
- delegation åˆç´„å¯¦ä½œæ‡‰é€šééœæ…‹åˆ†æå·¥å…·ï¼ˆå¦‚ Slitherï¼‰èˆ‡å½¢å¼é©—è­‰ï¼ˆå¦‚ MythXï¼‰ã€‚
- è«‹é¿å…å‹•æ…‹ dispatch çµæ§‹èˆ‡éå¤š callã€delegatecallï¼Œæ¸›å°‘æ½›åœ¨æ”»æ“Šé¢ã€‚
- è¨­è¨ˆæ‡‰ç¬¦åˆæœ€å°ä¿¡ä»»åŸå‰‡èˆ‡æ¨¡çµ„åŒ–ï¼ˆå¦‚ OpenZeppelin AccessControlï¼‰ã€‚

> EIP-7702 çš„ delegation contract ä¸¦éè¬ç”¨ proxyï¼Œæ‡‰ç²¾ç¢ºå°æ‡‰ç‰¹å®šäº¤æ˜“å‹æ…‹æˆ–é‚è¼¯ï¼Œå¯¦ä½œæ™‚å®œæ¡ whitelistã€é™æ¬Šã€é¢¨æ§å¤šå±¤äº¤å‰é©—è­‰ï¼Œä¸¦ä»¥ä½è¤‡é›œåº¦ã€é«˜å¯å¯©è¨ˆç‚ºåŸå‰‡ã€‚

### 2025.05.19

### EIP-7702 Ã— ERC-4337ï¼šæ•´åˆå¯¦ä½œèˆ‡æ‡‰ç”¨ç­–ç•¥

EIP-7702 æä¾› L1 åŸç”Ÿå¸³æˆ¶æŠ½è±¡åŠŸèƒ½ï¼Œä¸ä¾è³´ EntryPointï¼Œè¨­è¨ˆæ›´è¼•é‡ä¸”èˆ‡ç¾æœ‰äº¤æ˜“é‚è¼¯ç›¸å®¹ï¼›è€Œ ERC-4337 å‰‡é€é Bundler èˆ‡ EntryPoint æä¾› L2 æŠ½è±¡åŒ–éŒ¢åŒ…æ¶æ§‹ã€‚å…©è€…å¯äº’è£œæ•´åˆï¼Œå½¢æˆæ··åˆå‹å¸³æˆ¶æŠ½è±¡æ¡†æ¶ã€‚

#### çµåˆæ–¹å¼èˆ‡æ‡‰ç”¨é‚è¼¯

- **Delegation contract å¯å¯¦ä½œ `validateUserOp()` èˆ‡ `execute()`**ï¼Œèˆ‡ ERC-4337 çš„ EntryPoint å®Œæ•´å°æ¥ï¼Œå¯¦ç¾å…¼å®¹å‹å¸³æˆ¶æŠ½è±¡ã€‚
- **æ–¼ 4337 wallet ä¸­å¼•å…¥ delegation pattern**ï¼Œå¯æ”¯æ´ fallback recoveryã€session keyã€é™æ¬Šäº¤æ˜“ç­‰å½ˆæ€§æ©Ÿåˆ¶ã€‚
- **EIP-7702 æä¾› fallback æ©Ÿåˆ¶**ï¼šè‹¥ä¸»é©—ç°½å¤±æ•ˆï¼Œå¯æ”¹ç”± delegation contract å¯¦ä½œ `isValidSignature()` é©—è­‰é‚è¼¯ã€‚
- **æ”¯æ´äºŒéšæ®µæˆæ¬Šæ¶æ§‹**ï¼šç°½åèˆ‡åŸ·è¡Œè¡Œç‚ºå¯ç”±ä¸åŒ signer æ“ä½œï¼Œå¯¦ç¾æˆæ¬Šèˆ‡ä½¿ç”¨è²¬ä»»åˆ†é›¢ã€‚
- **UserOperation å¯å¢è¨­ `delegationProof` æ¬„ä½**ï¼Œæä¾›åŸºæ–¼ EIP-7702 æˆæ¬Šçš„é¡å¤–é©—è­‰ä¾†æºèˆ‡é¢¨æ§ä¾æ“šã€‚
- **æ··åˆæ¨¡å¼å¯ä¾éœ€æ±‚åˆ†æµ**ï¼šæ‰¹æ¬¡è™•ç†äº¤ç”± ERC-4337 è™•ç†ï¼Œç´°ç·»æ“ä½œå‰‡ç”± EIP-7702 é€²è¡Œå€‹åˆ¥æˆæ¬Šã€‚

#### å„ªå‹¢ç¸½çµ

- **çµ„åˆå½ˆæ€§é«˜**ï¼šEIP-7702 å¯æä¾› L1 å®‰å…¨ä¸”å¯æ§çš„é‚è¼¯æˆæ¬Šï¼ŒERC-4337 æä¾›ç­–ç•¥å°è£èˆ‡æ‰¹æ¬¡è™•ç†åŠŸèƒ½ã€‚
- **å®‰å…¨è¨­è¨ˆæ›´é€²éš**ï¼šfallback æ©Ÿåˆ¶è®“å¸³æˆ¶æ“æœ‰å¤šå±¤æ¬¡é©—ç°½é€”å¾‘èˆ‡å‚™æ´é‚è¼¯ã€‚
- **æœªä¾†å¯å»ºæ§‹ Layered Account Abstraction æ¶æ§‹**ï¼š4337 ç‚ºç­–ç•¥èˆ‡æ’ç¨‹å±¤ï¼Œ7702 æä¾›åº•å±¤ delegation é‚è¼¯èˆ‡åŸ·è¡Œæ§åˆ¶ã€‚

> EIP-7702 èˆ‡ ERC-4337 ä¸¦éå°ç«‹ï¼Œè€Œæ˜¯äº’è£œï¼šå‰è€…å¼·åŒ– L1 åŸ·è¡Œå®‰å…¨æ€§èˆ‡ç°¡æ½”æ€§ï¼Œå¾Œè€…æ“´å±•éŒ¢åŒ…è¡Œç‚ºèˆ‡æ‰¹æ¬¡èƒ½åŠ›ã€‚æœªä¾†å¸³æˆ¶æŠ½è±¡æ¨™æº–ä¸­ï¼ŒEIP-7702 æœ‰æ½›åŠ›æˆç‚º recoveryã€fallbackã€é™æ¬Š session çš„é—œéµå…ƒä»¶ã€‚

### 2025.05.20

### EIP-7702ï¼šäº¤æ˜“å»ºæ§‹èˆ‡ Viem å¯¦ä½œ

#### Viem å¯¦ä½œäº¤æ˜“æµç¨‹

é€é Viem ç™¼é€ EIP-7702 é¡å‹ï¼ˆType 4ï¼‰çš„ smart account äº¤æ˜“ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1. ä½¿ç”¨ `signAuthorization()` å°æŸå€‹ delegation contract ç”¢ç”Ÿç°½ç« ã€‚
2. å»ºç«‹äº¤æ˜“æ™‚ï¼Œå°‡ `to` è¨­ç‚º **EOA è‡ªå·±çš„åœ°å€**ã€‚
3. `data` ç‚ºå‘¼å« implementation contractï¼ˆå³ä»£ç†é‚è¼¯åˆç´„ï¼‰çš„ `execute(calls)` æ–¹æ³•ã€‚
4. å¸¶å…¥ `authorizationList`ï¼Œç¢ºä¿æˆæ¬Šç”Ÿæ•ˆã€‚
5. å¯ç”±è‡ªå·±æˆ– sponsor ä»£ç‚ºé€å‡ºäº¤æ˜“ï¼ˆsponsored executionï¼‰ã€‚

---

#### Viem TypeScript å¯¦ä½œç¨‹å¼ç¢¼

```ts
import { createWalletClient, http, parseEther } from 'viem';
import { anvil } from 'viem/chains';
import { privateKeyToAccount } from 'viem/accounts';
import { eip7702Actions } from 'viem/experimental';
import { abi, contractAddress } from './contract'; // Assuming you have already deployed the contract and exported the ABI and contract address in a separate file

const account = privateKeyToAccount('0x...'); // EOA çš„ç§é‘°ç”¢ç”Ÿå¸³æˆ¶

const walletClient = createWalletClient({
  account,
  chain: anvil,
  transport: http(),
}).extend(eip7702Actions()); // åŠ å…¥ EIP-7702 æ“´å……åŠŸèƒ½

// Step 1: ç”¢ç”Ÿå° implementation contract çš„ç°½ç« æˆæ¬Š
const authorization = await walletClient.signAuthorization({
  contractAddress,
});

// Step 2~4: çµ„è£èˆ‡é€å‡ºäº¤æ˜“
const hash = await walletClient.sendTransaction({
  to: walletClient.account.address, // è¨­ç‚º smart account æœ¬èº«åœ°å€
  authorizationList: [authorization],
  data: encodeFunctionData({
    abi,
    functionName: 'execute',
    args: [
      [
        {
          to: '0xcb98643b8786950F0461f3B0edf99D88F274574D',
          value: parseEther('0.001'),
          data: '0x',
        },
        {
          to: '0xd2135CfB216b74109775236E36d4b433F1DF507B',
          value: parseEther('0.002'),
          data: '0x',
        },
      ],
    ],
  }),
});
```

#### Flow of EIP-7702 Transaction
![image](https://github.com/user-attachments/assets/5cf8e323-3ccb-475a-887e-1866b7866c1e)

### 2025.05.21

ğŸ”— ç¯„ä¾‹ä¾†æºï¼šhttps://github.com/quiknode-labs/qn-guide-examples/blob/main/ethereum/eip-7702/src/BatchCallAndSponsor.sol

### EIP-7702ï¼šç¯„ä¾‹ Delegation åˆç´„ `BatchCallAndSponsor.sol` é‡é»ç­†è¨˜

#### åˆç´„ç›®çš„
- ä½œç‚º EOA çš„å§”æ´¾é‚è¼¯åˆç´„ï¼ˆdelegation contractï¼‰ã€‚
- æ”¯æ´ batch å‘¼å«èˆ‡ sponsor åŸ·è¡Œé‚è¼¯ï¼Œç¬¦åˆ EIP-7702 çš„è‡¨æ™‚å‡ç´šè¨­è¨ˆã€‚

#### ç°½ç« é‚è¼¯
- ä½¿ç”¨ `keccak256(nonce, calls)` ä½œç‚ºç°½åå…§å®¹ï¼Œæ­é… ECDSA é©—è­‰ã€‚
- é€é `ECDSA.recover(...) == address(this)` é©—è­‰è©²ç­†æ“ä½œç¢ºå¯¦ä¾†è‡ªè©² smart accountã€‚
- ä½¿ç”¨ `MessageHashUtils.toEthSignedMessageHash(...)` å°‡ digest åŒ…è£ç‚ºæ¨™æº– Ethereum ç°½ç« æ ¼å¼ã€‚

#### åŸ·è¡Œæ–¹å¼
- `function execute(Call[] calldata calls)`ï¼šåƒ…å…è¨± smart account è‡ªèº«å‘¼å«ã€‚
- `function execute(Call[] calldata calls, bytes calldata signature)`ï¼šç”± sponsor å‘¼å«ï¼Œéœ€é™„å¸¶é›¢ç·šç°½ç« ã€‚

#### çµæ§‹å®šç¾©
```solidity
struct Call {
    address to;
    uint256 value;
    bytes data;
}
```
- ç”¨æ–¼æ‰¹æ¬¡åŸ·è¡Œå¤šç­†äº¤æ˜“ï¼Œæ¯ç­†äº¤æ˜“å¯å¸¶é‡‘é¡èˆ‡ calldataã€‚

#### Replay Protection
- ä½¿ç”¨ `public nonce` ä½œç‚ºæ¯ç­†äº¤æ˜“çš„é˜²é‡æ”¾æ©Ÿåˆ¶ã€‚
- ç°½ç« æ™‚èˆ‡åŸ·è¡Œæ™‚çš†éœ€é©—è­‰ nonce æ˜¯å¦ä¸€è‡´ï¼ŒæˆåŠŸåŸ·è¡Œå¾Œè‡ªå‹•éå¢ã€‚

#### é‚è¼¯æ‹†åˆ†
- `_executeBatch()`ï¼šè™•ç†æ‰¹æ¬¡å…§æ‰€æœ‰å‘¼å«ï¼ŒåŒ…å« nonce å¢åŠ èˆ‡ emit eventã€‚
- `_executeCall()`ï¼šå–®ç­† call çš„å…·é«”åŸ·è¡Œè¡Œç‚ºã€‚

#### äº‹ä»¶è¨˜éŒ„
- `event CallExecuted(...)`ï¼šå–®ç­† call åŸ·è¡Œã€‚
- `event BatchExecuted(...)`ï¼šæ•´æ‰¹ call åŸ·è¡Œã€‚

#### è£œå……
- åˆç´„å¯æ”¶ ETHï¼ˆå¯¦ä½œ `fallback()` èˆ‡ `receive()`ï¼‰ã€‚
- æœ¬ç¯„ä¾‹åˆç´„ç‚ºã€Œå–®å¸³æˆ¶å°ˆç”¨ã€ï¼Œå¦‚éœ€å¤šäººå…±ç”¨æ‡‰åŠ å…¥ mapping æ¬Šé™ç®¡ç†ã€‚
- è©²åˆç´„è¨­è¨ˆç°¡æ½”æ˜ç¢ºï¼Œç‚ºç†è§£ EIP-7702 delegation æ©Ÿåˆ¶çš„é‡è¦ç¯„ä¾‹ï¼Œå¯¦ä½œå¯ç›´æ¥ç”¨æ–¼ Foundry æ¸¬è©¦èˆ‡ Viem integrationã€‚

<!-- Content_END -->
